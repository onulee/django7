{% extends 'base.html' %}
{% load static %}
{% block title %}SafeMap | í™ˆ{% endblock %}
{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}
{% block content %}

<style>
.main-split-container {
  display: flex;
  width: 100%;
  min-height: 600px;
  margin-top: 32px;
}
.main-split-left, .main-split-right {
  flex: 1;
  padding: 32px 24px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.main-split-divider {
  width: 2px;
  background: #e0e0e0;
  min-height: 500px;
  margin: 0 0;
}
@media (max-width: 900px) {
  .main-split-container {
    flex-direction: column;
  }
  .main-split-divider {
    width: 100%;
    height: 2px;
    min-height: unset;
    margin: 24px 0;
  }
}
</style>
<div class="main-split-container">
  <div class="main-split-left">
    <section class="hero">
      <div class="badge">âš¡ ìš”ì•½Â·ë¶„ë¥˜Â·ìœ„í—˜ë„ â†’ ì§€ë„ í‘œì‹œ</div>
      <h1 class="h1">ìš°ë¦¬ ë™ë„¤ ì‚¬ê±´Â·ì‚¬ê³ ,<br>í•œ ì¤„ë¡œ ìš”ì•½í•´ì„œ ì§€ë„ì—</h1>
      <p class="sub">
        ì œë³´ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ 1ì¤„ ìš”ì•½, ìœ í˜• ë¶„ë¥˜, ìœ„í—˜ë„(1~5)ë¥¼ ìë™ ì‚°ì¶œí•´
        ëˆ„êµ¬ë‚˜ ë¹ ë¥´ê²Œ ì§€ì—­ ì•ˆì „ ì‹ í˜¸ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
      </p>
      <div class="btnrow">
        <a class="btn primary" href="{% url 'reports:new' %}">+ ì œë³´ ë“±ë¡</a>
        <a class="btn" href="{% url 'reports:map' %}">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</a>
        <a class="btn" href="{% url 'chatbot:chat' %}">ğŸ’¬ ì±—ë´‡ ìƒë‹´</a>
      </div>
    </section>
    <section class="grid grid-3" style="margin-top:18px;">
      <div class="card kpi">
        <div>
          <div class="small">ìµœê·¼ 7ì¼ ì œë³´</div>
          <div class="num">{{ last7 }}</div>
        </div>
        <div class="badge">ğŸ“† 7 days</div>
      </div>
      <div class="card kpi">
        <div>
          <div class="small">ìµœê·¼ 30ì¼ ì œë³´</div>
          <div class="num">{{ last30 }}</div>
        </div>
        <div class="badge">ğŸ—“ï¸ 30 days</div>
      </div>
      <div class="card kpi">
        <div>
          <div class="small">ìµœê·¼ 7ì¼ í‰ê·  ìœ„í—˜ë„</div>
          <div class="num">{{ avg_risk_7 }}</div>
        </div>
        <div class="badge">â­ 1~5</div>
      </div>
    </section>
    <section class="grid grid-3" style="margin-top:16px;">
      <div class="card">
        <h3>ğŸ§  AI ìš”ì•½</h3>
        <div class="small">ê¸´ ì œë³´ë¥¼ 1ì¤„ë¡œ ì••ì¶•í•´ â€œí•œ ëˆˆì—â€ ë³´ì´ê²Œ.</div>
      </div>
      <div class="card">
        <h3>ğŸ·ï¸ ìë™ ë¶„ë¥˜</h3>
        <div class="small">êµí†µ/í­ë ¥/ë¶„ì‹¤/í™”ì¬ ë“± ìœ í˜•ì„ ìë™ íŒë‹¨.</div>
      </div>
      <div class="card">
        <h3>âš ï¸ ìœ„í—˜ë„ ì ìˆ˜</h3>
        <div class="small">1~5 ì ìœ¼ë¡œ ìš°ì„  í™•ì¸í•  ì‚¬ê±´ì„ ì •ë¦¬.</div>
      </div>
    </section>
  </div>
  <div class="main-split-divider"></div>
  <div class="main-split-right">
    <style>
      .datepop-bg {
        background: #f8fafd;
        border-radius: 24px;
        padding: 20px 12px 12px 12px;
        min-height: 400px;
        max-height: 550px;
        position: relative;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .datepop-header {
        width: 100%;
        text-align: center;
        font-weight: bold;
        font-size: 1.3rem;
        letter-spacing: 1px;
        margin-bottom: 12px;
        color: #111;
      }
      .datepop-nav {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin-bottom: 18px;
        font-size: 1.1rem;
        color: #111;
      }
      .datepop-nav .active {
        border-bottom: 2px solid #222;
        font-weight: bold;
        color: #111;
      }
      .datepop-map {
        width: 95%;
        background: #fff;
        border-radius: 20px;
        padding: 16px 8px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        max-height: 420px;
        overflow-y: auto;
        color: #111;
      }
      .datepop-region {
        width: 48%;
        height: 70px;
        background: #eaf7fa;
        border-radius: 14px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        font-weight: 500;
        color: #111;
        cursor: pointer;
      }
    </style>
    <div class="datepop-bg">
      <div class="datepop-header">DATE POP</div>
      <!-- ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ì œê±°ë¨ -->
      <div class="datepop-map" id="region-list"></div>
      <div id="subregion-list" style="width:95%;margin:0 auto 0 auto;"></div>

      <script>
      // DATE POP: ì „êµ­ ì‹œ/ë„ â†’ ì‹œ/êµ°/êµ¬ â†’ ì/ë©´/ë™ (ë™ì  ë¡œë”©)
      const regionList = document.getElementById('region-list');
      const subregionList = document.getElementById('subregion-list');
      let currentSido = null;
      let currentSigungu = null;

      function renderRegions(items, levelLabel){
        if(!regionList) return;
        regionList.innerHTML = '';
        if(levelLabel){
          const hdr = document.createElement('div');
          hdr.style.cssText = 'width:100%;font-weight:bold;margin:6px 4px 10px 4px;';
          hdr.textContent = levelLabel;
          regionList.appendChild(hdr);
        }
        const frag = document.createDocumentFragment();
        items.forEach(name => {
          const d = document.createElement('div');
          d.className = 'datepop-region';
          d.dataset.name = name;
          d.textContent = name;
          frag.appendChild(d);
        });
        regionList.appendChild(frag);
      }

      function renderBack(action, label){
        const back = document.createElement('div');
        back.className = 'datepop-region';
        back.style.background = '#f1f3f5';
        back.dataset.action = action;
        back.textContent = label || 'â† ë’¤ë¡œ';
        regionList.prepend(back);
      }

      async function fetchJSON(url){
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        return await res.json();
      }

      async function loadSido(){
        currentSido = null; currentSigungu = null;
        subregionList.innerHTML = '';
        const j = await fetchJSON('/api/kr-admin/?level=sido');
        const items = j.items || [];
        // Reorder: ì„œìš¸íŠ¹ë³„ì‹œ â†’ ê²½ê¸°ë„ â†’ ê´‘ì—­ì‹œë“¤(ì¸ì²œ/ë¶€ì‚°/ëŒ€êµ¬/ê´‘ì£¼/ëŒ€ì „/ìš¸ì‚°/ì„¸ì¢…) â†’ ë‚˜ë¨¸ì§€
        const FIRST = ['ì„œìš¸íŠ¹ë³„ì‹œ','ê²½ê¸°ë„'];
        const METROS = ['ì¸ì²œê´‘ì—­ì‹œ','ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ê´‘ì£¼ê´‘ì—­ì‹œ','ëŒ€ì „ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ'];
        const remain = new Set(items);
        const ordered = [];
        FIRST.forEach(n=>{ if(remain.has(n)){ ordered.push(n); remain.delete(n);} });
        METROS.forEach(n=>{ if(remain.has(n)){ ordered.push(n); remain.delete(n);} });
        ordered.push(...Array.from(remain));
        renderRegions(ordered, 'ì‹œ/ë„ ì„ íƒ');
      }

      async function loadSigungu(sido){
        currentSido = sido; currentSigungu = null;
        subregionList.innerHTML = '';
        const j = await fetchJSON(`/api/kr-admin/?sido=${encodeURIComponent(sido)}`);
        renderRegions(j.items || [], `${sido} Â· ì‹œ/êµ°/êµ¬ ì„ íƒ`);
        renderBack('back-sido', 'â† ì‹œ/ë„ ëª©ë¡');
      }

      async function loadDong(sido, sigungu){
        currentSigungu = sigungu;
        subregionList.innerHTML = '';
        const j = await fetchJSON(`/api/kr-admin/?sido=${encodeURIComponent(sido)}&sigungu=${encodeURIComponent(sigungu)}`);
        const items = j.items || [];
        // ë™ ëª©ë¡ì„ ë°”ë¡œ ë©”ì¸ ì˜ì—­(regionList)ì— í‘œì‹œ
        renderRegions(items, `${sido} â€º ${sigungu} Â· ë™ ì„ íƒ`);
        renderBack('back-sigungu', 'â† ì‹œ/êµ°/êµ¬ ëª©ë¡');
        // ë Œë”ëœ íƒ€ì¼ì„ ë™ ì„ íƒìœ¼ë¡œ ë³€ê²½(name -> dong)
        Array.from(regionList.querySelectorAll('.datepop-region')).forEach(el => {
          if(el.dataset.name){
            el.dataset.dong = el.dataset.name;
            delete el.dataset.name;
          }
        });
      }

      function gotoMapWithRegion(sido, sigungu, dong){
        const parts = [sido, sigungu, dong].filter(Boolean).join(' ');
        const url = `/reports/map?region=${encodeURIComponent('ëŒ€í•œë¯¼êµ­ '+parts)}`;
        window.location.href = url;
      }

      if(regionList){
        regionList.addEventListener('click', async (e)=>{
          const t = e.target;
          if(!t.classList.contains('datepop-region')) return;
          if(t.dataset.action === 'back-sido'){
            await loadSido();
            return;
          }
          if(t.dataset.action === 'back-sigungu'){
            await loadSigungu(currentSido);
            return;
          }
          // ë™ íƒ€ì¼ í´ë¦­ ì‹œ ì§€ë„ ì´ë™
          if(t.dataset.dong){
            gotoMapWithRegion(currentSido, currentSigungu, t.dataset.dong);
            return;
          }
          const name = t.dataset.name;
          if(!currentSido){
            await loadSigungu(name);
          } else if(currentSido && !currentSigungu){
            await loadDong(currentSido, name);
          }
        });


        // init
        loadSido();
      }
      </script>
      <!-- ì¿ í° ë°•ìŠ¤ ì œê±°ë¨ -->
    </div>
  </div>
 </div>

  <!-- ì•ˆì „ ê·¸ë˜í”„ ì„¹ì…˜ -->
  <div id="safety-graphs" class="grid grid-2" style="margin-top:32px;">
    <div class="card">
      <h3 style="margin:0 0 8px;">ìµœê·¼ 30ì¼ ì‚¬ê±´ ì¶”ì´</h3>
      <div class="small">DBì— ìŒ“ì¸ ì œë³´ ê¸°ì¤€ìœ¼ë¡œ ìë™ ê·¸ë˜í”„.</div>
      <canvas id="chartDaily" height="140"></canvas>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px;">ìœ í˜• ë¶„í¬</h3>
      <div class="small">ì‚¬ê±´/ì‚¬ê³  í°í‹€ ê¸°ì¤€: ë²”ì£„ â†’ êµí†µì‚¬ê³  â†’ ìì—°ì¬í•´ ìˆœ</div>
      <canvas id="chartCat" height="140"></canvas>
    </div>
  </div>

  <script>
  async function loadHomeCharts(){
    try{
      const res = await fetch('/reports/api/stats/?days=30');
      const data = await res.json();

      const dailyCtx = document.getElementById('chartDaily');
      const catCtx = document.getElementById('chartCat');

      if(!dailyCtx || !catCtx) return;

      new Chart(dailyCtx, {
        type: 'line',
        data: {
          labels: data.daily.labels,
          datasets: [{ label: 'ê±´ìˆ˜', data: data.daily.counts, tension: 0.25 }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      new Chart(catCtx, {
        type: 'bar',
        data: {
          labels: data.categories.labels.map(cat => {
            const MAP = {
              'violence': 'ë²”ì£„',
              'traffic': 'êµí†µì‚¬ê³ ',
              'fire': 'ìì—°ì¬í•´',
              'lost': 'ë¶„ì‹¤/ë„ë‚œ',
              'etc': 'ê¸°íƒ€'
            };
            return MAP[cat] || cat;
          }),
          datasets: [{ label: 'ê±´ìˆ˜', data: data.categories.counts }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }catch(e){
      console.log('home chart error', e);
    }
  }
  document.addEventListener('DOMContentLoaded', loadHomeCharts);
  </script>

{% endblock %}
