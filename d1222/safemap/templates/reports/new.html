{% extends 'base.html' %}
{% block title %}SafeMap | ì œë³´ ë“±ë¡{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
{% block content %}
<div class="card">
  <h2 style="margin:0 0 8px;">ì œë³´ ë“±ë¡</h2>
  <div class="small" style="opacity:.9">
    ìœ„ë„/ê²½ë„ëŠ” ìˆ¨ê¸°ê³ , <b>ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ì°ìœ¼ë©´</b> â€œë¬´ìŠ¨ ì‹œ/êµ¬/ë™â€ê¹Œì§€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
  </div>
</div>

<div class="grid grid-2" style="margin-top:14px;">
  <div class="card">
    <h3 style="margin:0 0 10px;">ìœ„ì¹˜ ì„ íƒ</h3>

    <div class="btnrow" style="margin-bottom:10px;">
      <input id="qAddr" placeholder="ë„ì‹œ/êµ¬/ë™ ê²€ìƒ‰ (ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™)" style="flex:1;"/>
      <button class="btn primary" type="button" onclick="searchAddress()">ê²€ìƒ‰</button>
    </div>

    <div id="map" style="height:420px;border-radius:16px;overflow:hidden;"></div>

    <div class="small" style="margin-top:10px;">
      ì„ íƒëœ ì£¼ì†Œ: <b id="pickedAddr">(ì•„ì§ ì„ íƒ ì•ˆ ë¨)</b><br>
      í–‰ì •êµ¬ì—­: <span id="pickedAdmin">(ë¯¸ì •)</span>
    </div>

    <div class="notice small" style="margin-top:10px;">
      ì§€ë„ í´ë¦­ ë˜ëŠ” ê²€ìƒ‰ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì •í•˜ì„¸ìš”. (ì™¸ë¶€ API ì‹¤íŒ¨í•´ë„ ì„œë²„ëŠ” ì•ˆ í„°ì§)
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">ë‚´ìš©</h3>

    <form method="post">
      {% csrf_token %}

      {{ form.lat }}
      {{ form.lng }}
      {{ form.address_text }}
      {{ form.sido }}
      {{ form.sigungu }}
      {{ form.dong }}

      <label>ì œëª©</label>
      {{ form.title }}{{ form.title.errors }}

      <label style="margin-top:10px;">ë‚´ìš©</label>
      {{ form.content }}{{ form.content.errors }}

      <label style="margin-top:10px;">ë°œìƒ ì‹œê°</label>
      {{ form.happened_at }}{{ form.happened_at.errors }}

      <div class="btnrow" style="margin-top:14px;">
        <button class="btn primary" type="submit">ì €ì¥</button>
        <a class="btn" href="{% url 'reports:map' %}">ì§€ë„</a>
      </div>

      <div class="small" style="margin-top:10px;opacity:.85">
        ìë™ ì²˜ë¦¬: 1ì¤„ ìš”ì•½ / ìœ í˜• ë¶„ë¥˜ / ìœ„í—˜ë„(1~5) â€” ì €ì¥ ì‹œ ì„œë²„ì—ì„œ ê³„ì‚°ë©ë‹ˆë‹¤.
      </div>
    </form>
  </div>
</div>

<script>
let map = L.map('map').setView([37.5665, 126.9780], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let marker = null;

function setMarker(lat, lng) {
  if(marker) marker.remove();
  marker = L.marker([lat, lng], {draggable:true}).addTo(map);
  marker.on('dragend', async () => {
    const p = marker.getLatLng();
    await reverseGeocode(p.lat, p.lng);
  });
}

async function reverseGeocode(lat, lng) {
  // Nominatim reverse (no key). It can fail -> we just degrade gracefully.
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=18&addressdetails=1&lat=${lat}&lon=${lng}&accept-language=ko`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    const j = await res.json();

    const display = j.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    document.getElementById('pickedAddr').textContent = display;

    const addr = j.address || {};
    const sido = addr.state || addr.region || '';
    const sigungu = addr.city || addr.county || addr.borough || '';
    const dong = addr.suburb || addr.neighbourhood || addr.quarter || addr.village || '';

    document.getElementById('pickedAdmin').textContent = `${sido} ${sigungu} ${dong}`.trim() || '(ë¯¸ì •)';

    // Fill hidden form fields
    const fLat = document.getElementById('id_lat');
    const fLng = document.getElementById('id_lng');
    const fAddr = document.getElementById('id_address_text');
    const fSido = document.getElementById('id_sido');
    const fSigungu = document.getElementById('id_sigungu');
    const fDong = document.getElementById('id_dong');

    if(fLat) fLat.value = lat;
    if(fLng) fLng.value = lng;
    if(fAddr) fAddr.value = display;
    if(fSido) fSido.value = sido;
    if(fSigungu) fSigungu.value = sigungu;
    if(fDong) fDong.value = dong;
  } catch(e) {
    document.getElementById('pickedAddr').textContent = '(ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨ â€” ê·¸ë˜ë„ ì €ì¥ì€ ê°€ëŠ¥)';
    const fLat = document.getElementById('id_lat');
    const fLng = document.getElementById('id_lng');
    if(fLat) fLat.value = lat;
    if(fLng) fLng.value = lng;
  }
}

async function searchAddress(){
  const q = document.getElementById('qAddr').value.trim();
  if(!q) return;
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=kr&addressdetails=1&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    const j = await res.json();
    if(!j || !j[0]) {
      alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ ğŸ˜¿ ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ!');
      return;
    }
    const lat = parseFloat(j[0].lat);
    const lng = parseFloat(j[0].lon);
    map.flyTo([lat, lng], 15, {duration: 0.8});
    setMarker(lat, lng);
    await reverseGeocode(lat, lng);
  } catch(e) {
    alert('ê²€ìƒ‰ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬).');
  }
}

map.on('click', async (e)=>{
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  setMarker(lat, lng);
  await reverseGeocode(lat, lng);
});

// Try user location on load
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    map.setView([lat,lng], 14);
    setMarker(lat,lng);
    reverseGeocode(lat,lng);
  }, ()=>{ /* ignore */ }, {enableHighAccuracy:true, timeout:5000});
}
</script>
{% endblock %}
