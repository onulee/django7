{% extends 'base.html' %}
{% block title %}SafeMap | ì§€ë„{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
{% block content %}
<div class="grid grid-2">
  <div class="card">
    <h2 style="margin:0 0 8px;">ì•ˆì „ ì§€ë„</h2>
    <div class="small">
      ìš°ë¦¬ ë™ë„¤ ì‚¬ê±´Â·ì‚¬ê³ ,<b> í•œ ì¤„ë¡œ ìš”ì•½í•´ì„œ ì§€ë„ì—</b>.<br>ì „êµ­ <b>ì‹œ/ë„ ì „ì²´</b> ì„ íƒ ê°€ëŠ¥ + (ì„ íƒ) ì‹œ/êµ°/êµ¬ëŠ” ê²€ìƒ‰ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.<br>
      ì œë³´ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ 1ì¤„ ìš”ì•½, ìœ í˜• ë¶„ë¥˜, ìœ„í—˜ë„(1~5)ë¥¼ ìë™ ì‚°ì¶œí•´ ëˆ„êµ¬ë‚˜ ë¹ ë¥´ê²Œ ì§€ì—­ ì•ˆì „ ì‹ í˜¸ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
    </div>

    <div class="btnrow" style="margin-top:12px;">
      <button class="btn" onclick="setDays(7)">ìµœê·¼ 7ì¼</button>
      <button class="btn" onclick="setDays(30)">ìµœê·¼ 30ì¼</button>
      <a class="btn primary" href="{% url 'reports:new' %}">+ ì œë³´</a>
    </div>

    <hr>

    <div class="small" style="margin-bottom:8px;">ì§€ì—­ ì„ íƒ</div>

    <label>ì‹œ/ë„</label>
    <select id="selSido"></select>

    <label style="margin-top:10px;">ì‹œ/êµ°/êµ¬ ê²€ìƒ‰(ì„ íƒ)</label>
    <input id="qSigungu" type="text" placeholder="ì˜ˆ: ê°•ë‚¨êµ¬ / ìˆ˜ì›ì‹œ / ì„œê·€í¬ì‹œ" />

    <div class="btnrow" style="margin-top:12px;">
      <button class="btn primary" onclick="applyRegion()">ì´ë™ + ë¡œë”©</button>
      <button class="btn" onclick="resetRegion()">ì „ì²´ ë³´ê¸°</button>
    </div>

    <hr>

    <div class="badge" id="regionLabel">ì „ì²´</div>
    <div class="small" id="stat" style="margin-top:10px;"></div>
    <div id="miniList" class="small" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>

    <div class="small" style="margin-top:10px; opacity:.8">
      * ì‹œ/êµ°/êµ¬ë¥¼ â€œì „ë¶€ ë“œë¦´ë‹¤ìš´ ë¦¬ìŠ¤íŠ¸â€ë¡œ ë„£ëŠ” ê±´ ë°ì´í„°ê°€ ì»¤ì„œ JSON(í–‰ì •êµ¬ì—­ ë°ì´í„°)ë¡œ ë¡œë”©í•˜ëŠ” ë°©ì‹ì´ ì •ì„ì´ì—ìš”.
      ì§€ê¸ˆ ë²„ì „ì€ ì„œë²„ ì•ˆ í„°ì§€ê²Œ â€œê²€ìƒ‰+bboxâ€ë¡œ ì•ˆì „í•˜ê²Œ ê°€ëŠ” MVP ë£¨íŠ¸ ğŸ˜¼
    </div>
  </div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div id="map" style="height:520px;"></div>
  </div>
</div>

<script>
let DAYS = 7;
const SIDO = [
  "ì„œìš¸íŠ¹ë³„ì‹œ","ë¶€ì‚°ê´‘ì—­ì‹œ","ëŒ€êµ¬ê´‘ì—­ì‹œ","ì¸ì²œê´‘ì—­ì‹œ","ê´‘ì£¼ê´‘ì—­ì‹œ","ëŒ€ì „ê´‘ì—­ì‹œ","ìš¸ì‚°ê´‘ì—­ì‹œ",
  "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ","ê²½ê¸°ë„","ê°•ì›íŠ¹ë³„ìì¹˜ë„","ì¶©ì²­ë¶ë„","ì¶©ì²­ë‚¨ë„","ì „ë¶íŠ¹ë³„ìì¹˜ë„","ì „ë¼ë‚¨ë„",
  "ê²½ìƒë¶ë„","ê²½ìƒë‚¨ë„","ì œì£¼íŠ¹ë³„ìì¹˜ë„"
];

let map = L.map('map').setView([36.5, 127.8], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

let layer = L.layerGroup().addTo(map);
let ACTIVE_BBOX = null; // [minLng,minLat,maxLng,maxLat] or null

function iconFor(item){
  let emoji = "âš ï¸";
  if(item.category === "violence") emoji = "ğŸš¨";
  else if(item.category === "fire") emoji = "ğŸ”¥";
  else if(item.category === "traffic") emoji = "ğŸš—";
  else if(item.category === "lost") emoji = "ğŸ§³";
  return L.divIcon({html: `<div style="font-size:22px;transform:translate(-8px,-12px)">${emoji}</div>`, className: '', iconSize: [20,20]});
}

function boundsToBbox(bounds){
  const sw = bounds.getSouthWest();
  const ne = bounds.getNorthEast();
  return [sw.lng, sw.lat, ne.lng, ne.lat];
}

function renderMiniList(items){
  const box = document.getElementById("miniList");
  if(!box) return;
  box.innerHTML = "";
  const top = (items || []).slice(0, 8);
  if(top.length === 0){
    box.innerHTML = `<div class="small" style="opacity:.8">í‘œì‹œí•  ì œë³´ê°€ ì•„ì§ ì—†ì–´.</div>`;
    return;
  }
  top.forEach((it) => {
    const line = document.createElement("div");
    line.className = "card";
    line.style.padding = "10px";
    line.style.borderRadius = "14px";
    line.style.borderColor = "rgba(255,255,255,.12)";
    const summary = (it.summary || "").replace(/\n/g, " ");
    line.innerHTML = `<b style="display:block;margin-bottom:4px">â€¢ ${summary || (it.title||'ì œë³´')}</b>
                      <a href="${it.detail_url}" class="small">ìƒì„¸ â†’</a>`;
    box.appendChild(line);
  });
}

async function loadMarkers(){

  layer.clearLayers();
  const params = new URLSearchParams();
  params.set("days", String(DAYS));
  if(ACTIVE_BBOX){ params.set("bbox", ACTIVE_BBOX.join(",")); }
  const url = `/reports/api/list/?` + params.toString();
  const res = await fetch(url);
  const data = await res.json();

  document.getElementById("stat").innerText =
    `í‘œì‹œì¤‘: ${data.count}ê±´ (ìµœê·¼ ${DAYS}ì¼)` + (ACTIVE_BBOX ? " Â· ì§€ì—­ í•„í„° ON" : " Â· ì „ì²´");

  renderMiniList(data.items || []);

  (data.items || []).forEach(item => {
    const m = L.marker([item.lat, item.lng], {icon: iconFor(item)}).addTo(layer);
    m.bindPopup(`<div style="max-width:260px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;"><b>${item.title}</b><span class=\"status-badge ${'status-' + (item.status || 'received')}\">${item.status_label || ''}</span></div>
        <div style="font-size:12px;opacity:.85;margin-top:4px">${item.summary}</div>
        <div style="font-size:12px;opacity:.75;margin-top:6px">ğŸ“ ${item.address_text || ''} ${item.sido || ''} ${item.sigungu || ''} ${item.dong || ''}</div>
        <div style="margin-top:8px"><a href="${item.detail_url}">ìƒì„¸ ë³´ê¸° â†’</a></div>
      </div>`);
  });
}

function setDays(d){ DAYS = d; loadMarkers(); }

function initSido(){
  const sel = document.getElementById("selSido");
  sel.innerHTML = "";
  SIDO.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  sel.value = "ì„œìš¸íŠ¹ë³„ì‹œ";
}

async function geocodeKorea(query){
  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=kr&q=" + encodeURIComponent(query);
  const res = await fetch(url, { headers: { "Accept": "application/json" } });
  const j = await res.json();
  if(!j || !j[0]) return null;
  return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon) };
}

async function applyRegion(){
  const sido = document.getElementById("selSido").value;
  const sigungu = document.getElementById("qSigungu").value.trim();
  let label = sido;

  if(sigungu){
    const loc = await geocodeKorea(`ëŒ€í•œë¯¼êµ­ ${sido} ${sigungu}`);
    if(loc){
      map.flyTo([loc.lat, loc.lng], 12, {animate:true, duration:0.9});
      label = `${sido} Â· ${sigungu}`;
    }else{
      const loc2 = await geocodeKorea(`ëŒ€í•œë¯¼êµ­ ${sido}`);
      if(loc2) map.flyTo([loc2.lat, loc2.lng], 9, {animate:true, duration:0.9});
    }
  }else{
    const loc = await geocodeKorea(`ëŒ€í•œë¯¼êµ­ ${sido}`);
    if(loc) map.flyTo([loc.lat, loc.lng], 9, {animate:true, duration:0.9});
  }

  ACTIVE_BBOX = boundsToBbox(map.getBounds());
  document.getElementById("regionLabel").innerText = label;
  loadMarkers();
}

function resetRegion(){
  ACTIVE_BBOX = null;
  document.getElementById("regionLabel").innerText = "ì „ì²´";
  map.flyTo([36.5, 127.8], 7, {animate:true, duration:0.9});
  loadMarkers();
}

initSido();
loadMarkers();

// Deep-link support: ?region=ëŒ€í•œë¯¼êµ­ ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™
(async function(){
  try{
    const params = new URLSearchParams(location.search);
    const region = params.get('region');
    if(region){
      const loc = await geocodeKorea(region);
      if(loc){
        map.flyTo([loc.lat, loc.lng], 12, {animate:true, duration:0.9});
        ACTIVE_BBOX = boundsToBbox(map.getBounds());
        document.getElementById('regionLabel').innerText = region.replace(/^ëŒ€í•œë¯¼êµ­\s*/, '');
        loadMarkers();
      }
    }
  }catch(e){/* ignore */}
})();
</script>
{% endblock %}
