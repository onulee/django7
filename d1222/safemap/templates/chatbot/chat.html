{% extends 'base.html' %}
{% block title %}SafeMap | ì±—ë´‡{% endblock %}
{% block content %}
<div class="grid grid-2">
  <div class="card">
    <h2 style="margin:0 0 8px;">ì•ˆì „ ì±—ë´‡</h2>
    <p class="small">ê¸°ë³¸ì€ ì•ˆì „ ê°€ì´ë“œ, ì¶”ê°€ë¡œ â€œë‚´ ê·¼ì²˜ ì•½êµ­/ë³‘ì› ì˜ì—…ì‹œê°„â€ë„ ì¡°íšŒ ê°€ëŠ¥(ì˜µì…˜).</p>
    <div class="notice small">ì£¼ì˜: ì‘ê¸‰ìƒí™©ì„ ëŒ€ì‹ í•˜ì§€ ì•ŠìŒ. ìƒëª…/ìœ„í˜‘ì´ë©´ ì¦‰ì‹œ 112/119.</div>
    <hr>
    <div id="log" style="display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;"></div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <input id="msg" placeholder="ì˜ˆ: ë‚´ ê·¼ì²˜ ì•½êµ­ ëª‡ì‹œì— ì—´ê³  ë‹«ì•„?">
      <button class="btn primary" onclick="sendMsg()">ì „ì†¡</button>
    </div>
    <div class="small" style="margin-top:10px;color:#9aa4c6">
      * ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ â€œë‚´ ê·¼ì²˜â€ ê¸°ëŠ¥ì´ ë™ì‘í•©ë‹ˆë‹¤. (í‚¤ ì—†ìœ¼ë©´ ì•ˆë‚´ë§Œ í•˜ê³  ëë‚¨)
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;">ë¹ ë¥¸ ì˜ˆì‹œ</h3>
    <div class="grid" style="gap:10px;">
      <button class="btn" onclick="quick('ë‚´ ê·¼ì²˜ ì•½êµ­ ëª‡ì‹œì— ì—´ê³  ë‹«ì•„?')">ğŸ’Š ë‚´ ê·¼ì²˜ ì•½êµ­</button>
      <button class="btn" onclick="quick('ë‚´ ê·¼ì²˜ ë³‘ì› ì˜¤í”ˆì‹œê°„ ì•Œë ¤ì¤˜')">ğŸ¥ ë‚´ ê·¼ì²˜ ë³‘ì›</button>
      <button class="btn" onclick="quick('ì—°ê¸° ë‚˜ê³  ë¶ˆì´ ë‚œ ê²ƒ ê°™ì•„')">ğŸ”¥ í™”ì¬</button>
      <button class="btn" onclick="quick('ëˆ„ê°€ í‰ê¸°ë¥¼ ë“¤ê³  ìœ„í˜‘í•´')">ğŸš¨ ìœ„í˜‘</button>
      <button class="btn" onclick="quick('ì°¨ ì¶”ëŒ ì‚¬ê³  ë‚¬ì–´')">ğŸš— êµí†µ</button>
      <button class="btn" onclick="quick('ì§€ê°‘ì„ ìƒì–´ë²„ë ¸ì–´')">ğŸ§³ ë¶„ì‹¤</button>
    </div>
    <hr>
    <div class="small">ì—…ê·¸ë ˆì´ë“œ ì•„ì´ë””ì–´</div>
    <ul class="small">
      <li>ì±—ë´‡ â†’ ì œë³´ í¼ ìë™ ì±„ìš°ê¸°(ì‹œê°„/ë‚´ìš©/ìœ„ì¹˜)</li>
      <li>ëŒ€í™” ì´ë ¥ ì €ì¥(ì„¸ì…˜/DB)</li>
      <li>ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ: â€œë°˜ê²½ ëŠ˜ë¦¬ê¸°â€ ë²„íŠ¼</li>
    </ul>
  </div>
</div>

<script>
let USER_LOC = {lat: null, lng: null};

async function ensureLocation(){
  if(USER_LOC.lat && USER_LOC.lng) return USER_LOC;
  return new Promise((resolve)=>{
    if(!navigator.geolocation) return resolve(USER_LOC);
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ USER_LOC.lat = pos.coords.latitude; USER_LOC.lng = pos.coords.longitude; resolve(USER_LOC); },
      ()=> resolve(USER_LOC),
      {enableHighAccuracy:true, timeout:8000}
    );
  });
}

function addBubble(who, text){
  const log = document.getElementById('log');
  const div = document.createElement('div');
  div.className = 'card';
  div.style.padding = '12px';
  div.style.borderRadius = '16px';
  div.style.borderColor = 'rgba(255,255,255,.12)';
  div.innerHTML = `<div class="badge">${who}</div><div style="margin-top:8px;white-space:pre-wrap">${text}</div>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

async function sendMsg(){
  const inp = document.getElementById('msg');
  const message = inp.value.trim();
  if(!message) return;
  addBubble('ë‚˜', message);
  inp.value = '';

  const loc = await ensureLocation();

  let res;
  try{
    res = await fetch('/chat/api/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': window.CSRF_TOKEN,
      },
      body: JSON.stringify({message, lat: loc.lat, lng: loc.lng})
    });
  }catch(e){
    addBubble('ë´‡', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜... ì ê¹ë§Œ. (ì„œë²„ ì¼œì ¸ìˆëŠ”ì§€ í™•ì¸ ã„±ã„±)');
    return;
  }

  let data;
  try{
    data = await res.json();
  }catch(e){
    addBubble('ë´‡', 'ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨. ì½˜ì†”/ì„œë²„ ë¡œê·¸ í™•ì¸ ã„±ã„±');
    return;
  }
  addBubble('ë´‡', data.reply);
}

function quick(t){
  document.getElementById('msg').value = t;
  sendMsg();
}

addBubble('ë´‡', 'ì•ˆì „ ì±—ë´‡ ì¤€ë¹„ì™„ë£Œ.\nì˜ˆ: â€œë‚´ ê·¼ì²˜ ì•½êµ­ ëª‡ì‹œì— ì—´ê³  ë‹«ì•„?â€ / â€œë‚´ ê·¼ì²˜ ë³‘ì› ì˜¤í”ˆì‹œê°„ ì•Œë ¤ì¤˜â€');
</script>
{% endblock %}
